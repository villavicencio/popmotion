'use strict';

exports.__esModule = true;

var _calc = require('../../inc/calc');

var BLEND_ACCURACY = 60;

exports.default = function (outAction, inAction, flowValue, key) {
  var outValue = outAction.values[key];

  if (outAction.elapsed === undefined || !outValue) {
    return;
  }

  var inValue = inAction.values[key];
  var outTotalDuration = outValue.delay + outValue.duration;
  var timeUntilOutEnd = Math.min(outTotalDuration - outAction.elapsed, inValue.delay + inValue.duration);
  var inPositionAtOutEnd = (0, _calc.ease)((0, _calc.restrict)((0, _calc.getProgressFromValue)(timeUntilOutEnd, 0, inValue.delay + inValue.duration), 0, 1), inValue.from, inValue.to, inValue.ease);
  var inBiggerThanOutAtStart = inValue.from > outValue.current;
  var inBiggerThanOutAtEnd = inPositionAtOutEnd > outValue.to;
  var tweensIntersect = inBiggerThanOutAtStart !== inBiggerThanOutAtEnd;

  var blendCurve = [[0, outValue.current], [timeUntilOutEnd, inPositionAtOutEnd]];

  // If tweens intersect, resolve tweens at a resolution to find exactly where
  if (tweensIntersect) {
    var timeStepToTest = timeUntilOutEnd / BLEND_ACCURACY;
    var foundP1 = false;
    var foundP2 = false;

    for (var i = 0; i <= BLEND_ACCURACY; i++) {
      var timeStep = i * timeStepToTest;
      var outAtTime = (0, _calc.ease)((0, _calc.getProgressFromValue)(outAction.elapsed + timeStep, outValue.delay, outValue.duration), outValue.from, outValue.to, outValue.ease);
      var inAtTime = (0, _calc.ease)((0, _calc.getProgressFromValue)(inAction.elapsed + timeStep, inValue.delay, inValue.duration), inValue.from, inValue.to, inValue.ease);

      if (!foundP1 && (inBiggerThanOutAtStart && inAtTime < outAtTime || !inBiggerThanOutAtStart && inAtTime > outAtTime)) {
        blendCurve.splice(1, 0, [timeStep, inAtTime]);
        foundP1 = true;
      }

      if (foundP1 && (inBiggerThanOutAtStart && inAtTime < outValue.current || !inBiggerThanOutAtStart && inAtTime > outValue.current)) {
        blendCurve[2] = [timeStep, inAtTime];
        foundP2 = true;
      }

      if (foundP2) {
        break;
      }
    }
  }

  if (blendCurve.length === 2) {
    // Pass between tweens using incoming easing if just two points
    return function () {
      var blendProgress = (0, _calc.restrict)((0, _calc.getProgressFromValue)(inAction.elapsed, blendCurve[0][0], blendCurve[1][0]), 0, 1);

      if (blendProgress === 1) {
        flowValue.blendCurve = undefined;
      }

      return (0, _calc.ease)(blendProgress, outValue.current, inValue.current, inValue.ease);
    };
  } else {
    // Pass between tweens using bezier interpolation
    return function () {
      var blendProgress = (0, _calc.restrict)((0, _calc.getProgressFromValue)(inAction.elapsed, blendCurve[0][0], blendCurve[2][0]), 0, 1);
      var aP = (0, _calc.getValueFromProgress)(blendProgress, blendCurve[0][1], blendCurve[1][1]);
      var bP = (0, _calc.getValueFromProgress)(blendProgress, blendCurve[1][1], blendCurve[2][1]);

      if (blendProgress === 1) {
        flowValue.blendCurve = undefined;
        return inValue.current;
      }

      return (0, _calc.getValueFromProgress)(blendProgress, aP, bP);
    };
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hY3Rpb25zL2Zsb3cvZ2VuZXJhdGUtYmxlbmQtY3VydmUuanMiXSwibmFtZXMiOlsiQkxFTkRfQUNDVVJBQ1kiLCJvdXRBY3Rpb24iLCJpbkFjdGlvbiIsImZsb3dWYWx1ZSIsImtleSIsIm91dFZhbHVlIiwidmFsdWVzIiwiZWxhcHNlZCIsInVuZGVmaW5lZCIsImluVmFsdWUiLCJvdXRUb3RhbER1cmF0aW9uIiwiZGVsYXkiLCJkdXJhdGlvbiIsInRpbWVVbnRpbE91dEVuZCIsIk1hdGgiLCJtaW4iLCJpblBvc2l0aW9uQXRPdXRFbmQiLCJmcm9tIiwidG8iLCJlYXNlIiwiaW5CaWdnZXJUaGFuT3V0QXRTdGFydCIsImN1cnJlbnQiLCJpbkJpZ2dlclRoYW5PdXRBdEVuZCIsInR3ZWVuc0ludGVyc2VjdCIsImJsZW5kQ3VydmUiLCJ0aW1lU3RlcFRvVGVzdCIsImZvdW5kUDEiLCJmb3VuZFAyIiwiaSIsInRpbWVTdGVwIiwib3V0QXRUaW1lIiwiaW5BdFRpbWUiLCJzcGxpY2UiLCJsZW5ndGgiLCJibGVuZFByb2dyZXNzIiwiYVAiLCJiUCJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBOztBQUVBLElBQU1BLGlCQUFpQixFQUF2Qjs7a0JBRWUsVUFBQ0MsU0FBRCxFQUFZQyxRQUFaLEVBQXNCQyxTQUF0QixFQUFpQ0MsR0FBakMsRUFBeUM7QUFDdEQsTUFBTUMsV0FBV0osVUFBVUssTUFBVixDQUFpQkYsR0FBakIsQ0FBakI7O0FBRUEsTUFBSUgsVUFBVU0sT0FBVixLQUFzQkMsU0FBdEIsSUFBbUMsQ0FBQ0gsUUFBeEMsRUFBa0Q7QUFDaEQ7QUFDRDs7QUFFRCxNQUFNSSxVQUFVUCxTQUFTSSxNQUFULENBQWdCRixHQUFoQixDQUFoQjtBQUNBLE1BQU1NLG1CQUFtQkwsU0FBU00sS0FBVCxHQUFpQk4sU0FBU08sUUFBbkQ7QUFDQSxNQUFNQyxrQkFBa0JDLEtBQUtDLEdBQUwsQ0FBU0wsbUJBQW1CVCxVQUFVTSxPQUF0QyxFQUErQ0Us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O0FBQ1gsVUFBTWUsZ0JBQWdCLG9CQUFTLGdDQUFxQmhDLFNBQVNLLE9BQTlCLEVBQXVDaUIsV0FBVyxDQUFYLEVBQWMsQ0FBZCxDQUF2QyxFQUF5REEsV0FBVyxDQUFYLEVBQWMsQ0FBZCxDQUF6RCxDQUFULEVBQXFGLENBQXJGLEVBQXdGLENBQXhGLENBQXRCO0FBQ0EsVUFBTVcsS0FBSyxnQ0FBcUJELGFBQXJCLEVBQW9DVixXQUFXLENBQVgsRUFBYyxDQUFkLENBQXBDLEVBQXNEQSxXQUFXLENBQVgsRUFBYyxDQUFkLENBQXRELENBQVg7QUFDQSxVQUFNWSxLQUFLLGdDQUFxQkYsYUFBckIsRUFBb0NWLFdBQVcsQ0FBWCxFQUFjLENBQWQsQ0FBcEMsRUFBc0RBLFdBQVcsQ0FBWCxFQUFjLENBQWQsQ0FBdEQsQ0FBWDs7QUFFQSxVQUFJVSxrQkFBa0IsQ0FBdEIsRUFBeUI7QUFDdkIvQixrQkFBVXFCLFVBQVYsR0FBdUJoQixTQUF2QjtBQUNBLGVBQU9DLFFBQVFZLE9BQWY7QUFDRDs7QUFFRCxhQUFPLGdDQUFxQmEsYUFBckIsRUFBb0NDLEVBQXBDLEVBQXdDQyxFQUF4QyxDQUFQO0FBQ0QsS0FYRDtBQVlEO0FBQ0YsQyIsImZpbGUiOiJnZW5lcmF0ZS1ibGVuZC1jdXJ2ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdldFByb2dyZXNzRnJvbVZhbHVlLCBnZXRWYWx1ZUZyb21Qcm9ncmVzcywgZWFzZSwgcmVzdHJpY3QgfSBmcm9tICcuLi8uLi9pbmMvY2FsYyc7XG5cbmNvbnN0IEJMRU5EX0FDQ1VSQUNZID0gNjA7XG5cbmV4cG9ydCBkZWZhdWx0IChvdXRBY3Rpb24sIGluQWN0aW9uLCBmbG93VmFsdWUsIGtleSkgPT4ge1xuICBjb25zdCBvdXRWYWx1ZSA9IG91dEFjdGlvbi52YWx1ZXNba2V5XTtcblxuICBpZiAob3V0QWN0aW9uLmVsYXBzZWQgPT09IHVuZGVmaW5lZCB8fCAhb3V0VmFsdWUpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBjb25zdCBpblZhbHVlID0gaW5BY3Rpb24udmFsdWVzW2tleV07XG4gIGNvbnN0IG91dFRvdGFsRHVyYXRpb24gPSBvdXRWYWx1ZS5kZWxheSArIG91dFZhbHVlLmR1cmF0aW9uO1xuICBjb25zdCB0aW1lVW50aWxPdXRFbmQgPSBNYXRoLm1pbihvdXRUb3RhbER1cmF0aW9uIC0gb3V0QWN0aW9uLmVsYXBzZWQsIGluVmFsdWUuZGVsYXkgKyBpblZhbHVlLmR1cmF0aW9uKTtcbiAgY29uc3QgaW5Qb3NpdGlvbkF0T3V0RW5kID0gZWFzZShyZXN0cmljdChnZXRQcm9ncmVzc0Zyb21WYWx1ZSh0aW1lVW50aWxPdXRFbmQsIDAsIGluVmFsdWUuZGVsYXkgKyBpblZhbHVlLmR1cmF0aW9uKSwgMCwgMSksIGluVmFsdWUuZnJvbSwgaW5WYWx1ZS50bywgaW5WYWx1ZS5lYXNlKTtcbiAgY29uc3QgaW5CaWdnZXJUaGFuT3V0QXRTdGFydCA9IGluVmFsdWUuZnJvbSA+IG91dFZhbHVlLmN1cnJlbnQ7XG4gIGNvbnN0IGluQmlnZ2VyVGhhbk91dEF0RW5kID0gaW5Qb3NpdGlvbkF0T3V0RW5kID4gb3V0VmFsdWUudG87XG4gIGNvbnN0IHR3ZWVuc0ludGVyc2VjdCA9IGluQmlnZ2VyVGhhbk91dEF0U3RhcnQgIT09IGluQmlnZ2VyVGhhbk91dEF0RW5kO1xuXG4gIGNvbnN0IGJsZW5kQ3VydmUgPSBbWzAsIG91dFZhbHVlLmN1cnJlbnRdLCBbdGltZVVudGlsT3V0RW5kLCBpblBvc2l0aW9uQXRPdXRFbmRdXTtcblxuICAvLyBJZiB0d2VlbnMgaW50ZXJzZWN0LCByZXNvbHZlIHR3ZWVucyBhdCBhIHJlc29sdXRpb24gdG8gZmluZCBleGFjdGx5IHdoZXJlXG4gIGlmICh0d2VlbnNJbnRlcnNlY3QpIHtcbiAgICBjb25zdCB0aW1lU3RlcFRvVGVzdCA9IHRpbWVVbnRpbE91dEVuZCAvIEJMRU5EX0FDQ1VSQUNZO1xuICAgIGxldCBmb3VuZFAxID0gZmFsc2U7XG4gICAgbGV0IGZvdW5kUDIgPSBmYWxzZTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDw9IEJMRU5EX0FDQ1VSQUNZOyBpKyspIHtcbiAgICAgIGNvbnN0IHRpbWVTdGVwID0gaSAqIHRpbWVTdGVwVG9UZXN0O1xuICAgICAgY29uc3Qgb3V0QXRUaW1lID0gZWFzZShnZXRQcm9ncmVzc0Zyb21WYWx1ZShvdXRBY3Rpb24uZWxhcHNlZCArIHRpbWVTdGVwLCBvdXRWYWx1ZS5kZWxheSwgb3V0VmFsdWUuZHVyYXRpb24pLCBvdXRWYWx1ZS5mcm9tLCBvdXRWYWx1ZS50bywgb3V0VmFsdWUuZWFzZSk7XG4gICAgICBjb25zdCBpbkF0VGltZSA9IGVhc2UoZ2V0UHJvZ3Jlc3NGcm9tVmFsdWUoaW5BY3Rpb24uZWxhcHNlZCArIHRpbWVTdGVwLCBpblZhbHVlLmRlbGF5LCBpblZhbHVlLmR1cmF0aW9uKSwgaW5WYWx1ZS5mcm9tLCBpblZhbHVlLnRvLCBpblZhbHVlLmVhc2UpO1xuXG4gICAgICBpZiAoIWZvdW5kUDEgJiYgKChpbkJpZ2dlclRoYW5PdXRBdFN0YXJ0ICYmIGluQXRUaW1lIDwgb3V0QXRUaW1lKSB8fCAoIWluQmlnZ2VyVGhhbk91dEF0U3RhcnQgJiYgaW5BdFRpbWUgPiBvdXRBdFRpbWUpKSkge1xuICAgICAgICBibGVuZEN1cnZlLnNwbGljZSgxLCAwLCBbdGltZVN0ZXAsIGluQXRUaW1lXSk7XG4gICAgICAgIGZvdW5kUDEgPSB0cnVlO1xuICAgICAgfVxuXG4gICAgICBpZiAoZm91bmRQMSAmJiAoKGluQmlnZ2VyVGhhbk91dEF0U3RhcnQgJiYgaW5BdFRpbWUgPCBvdXRWYWx1ZS5jdXJyZW50KSB8fCAoIWluQmlnZ2VyVGhhbk91dEF0U3RhcnQgJiYgaW5BdFRpbWUgPiBvdXRWYWx1ZS5jdXJyZW50KSkpIHtcbiAgICAgICAgYmxlbmRDdXJ2ZVsyXSA9IFt0aW1lU3RlcCwgaW5BdFRpbWVdO1xuICAgICAgICBmb3VuZFAyID0gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgaWYgKGZvdW5kUDIpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgaWYgKGJsZW5kQ3VydmUubGVuZ3RoID09PSAyKSB7XG4gICAgLy8gUGFzcyBiZXR3ZWVuIHR3ZWVucyB1c2luZyBpbmNvbWluZyBlYXNpbmcgaWYganVzdCB0d28gcG9pbnRzXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IGJsZW5kUHJvZ3Jlc3MgPSByZXN0cmljdChnZXRQcm9ncmVzc0Zyb21WYWx1ZShpbkFjdGlvbi5lbGFwc2VkLCBibGVuZEN1cnZlWzBdWzBdLCBibGVuZEN1cnZlWzFdWzBdKSwgMCwgMSk7XG5cbiAgICAgIGlmIChibGVuZFByb2dyZXNzID09PSAxKSB7XG4gICAgICAgIGZsb3dWYWx1ZS5ibGVuZEN1cnZlID0gdW5kZWZpbmVkO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gZWFzZShibGVuZFByb2dyZXNzLCBvdXRWYWx1ZS5jdXJyZW50LCBpblZhbHVlLmN1cnJlbnQsIGluVmFsdWUuZWFzZSk7XG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICAvLyBQYXNzIGJldHdlZW4gdHdlZW5zIHVzaW5nIGJlemllciBpbnRlcnBvbGF0aW9uXG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIGNvbnN0IGJsZW5kUHJvZ3Jlc3MgPSByZXN0cmljdChnZXRQcm9ncmVzc0Zyb21WYWx1ZShpbkFjdGlvbi5lbGFwc2VkLCBibGVuZEN1cnZlWzBdWzBdLCBibGVuZEN1cnZlWzJdWzBdKSwgMCwgMSk7XG4gICAgICBjb25zdCBhUCA9IGdldFZhbHVlRnJvbVByb2dyZXNzKGJsZW5kUHJvZ3Jlc3MsIGJsZW5kQ3VydmVbMF1bMV0sIGJsZW5kQ3VydmVbMV1bMV0pO1xuICAgICAgY29uc3QgYlAgPSBnZXRWYWx1ZUZyb21Qcm9ncmVzcyhibGVuZFByb2dyZXNzLCBibGVuZEN1cnZlWzFdWzFdLCBibGVuZEN1cnZlWzJdWzFdKTtcblxuICAgICAgaWYgKGJsZW5kUHJvZ3Jlc3MgPT09IDEpIHtcbiAgICAgICAgZmxvd1ZhbHVlLmJsZW5kQ3VydmUgPSB1bmRlZmluZWQ7XG4gICAgICAgIHJldHVybiBpblZhbHVlLmN1cnJlbnQ7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBnZXRWYWx1ZUZyb21Qcm9ncmVzcyhibGVuZFByb2dyZXNzLCBhUCwgYlApO1xuICAgIH07XG4gIH1cbn07XG4iXX0=